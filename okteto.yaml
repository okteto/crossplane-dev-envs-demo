icon: https://raw.githubusercontent.com/okteto/icons/main/oktaco.png

build:
  aws:
    context: app/aws

  menu:
    context: app/menu

  kitchen:
    context: app/kitchen

  kitchen-dev:
    context: app/kitchen
    target: dev

  check:
    context: app/check

deploy:
  commands:
  - name: Deploy the Menu microservice
    command: |
      helm upgrade --install menu menu/chart --set image=$OKTETO_BUILD_MENU_IMAGE --set queue=$SQS_QUEUE_URL --set author="${OKTETO_NAMESPACE}-${OKTETO_USERNAME}"

  - name: Deploy the Kitchen microservice
    command: helm upgrade --install kitchen kitchen/chart --set image=$OKTETO_BUILD_KITCHEN_IMAGE --set queue=$SQS_QUEUE_NAME --set check=https://check-${OKTETO_NAMESPACE}.${OKTETO_DOMAIN}/checks

  - name: Deploy the Check microservice
    command: |
     helm upgrade --install check check/chart --set image=${OKTETO_BUILD_CHECK_IMAGE} --set bucket="$S3_BUCKET_NAME"

dev:
  menu:
    command: bash
    sync:
    - menu:/usr/src/app
    forward:
    - 9229:9229

  kitchen:
    image: $OKTETO_BUILD_KITCHEN_DEV_IMAGE
    command: bash
    sync:
    - kitchen:/usr/src/app
    environment:
     GIN_MODE: debug

  check:
    command: bash
    sync:
    - check:/usr/src/app
    environment:
     RELOAD: true
